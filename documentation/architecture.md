# Архитектура проекта "Remote Jobs"

## Обзор

"Remote Jobs" - это фуллстек веб-приложение для поиска удаленных вакансий в сфере IT. Архитектура проекта построена на подходе серверного рендеринга (SSR) с использованием Go HTML-шаблонов, обеспечивая простоту разработки, сопровождения и высокую производительность.

## Технологический стек

- **Язык программирования**: Go
- **База данных**: PostgreSQL
- **Миграции**: Goose
- **Логирование**: Zap + BetterStack
- **Конфигурация**: Godotenv
- **Веб-фреймворк**: Chi (github.com/go-chi/chi)
- **Шаблонизатор**: Go HTML Templates (html/template)
- **CSS-фреймворк**: Bootstrap
- **JavaScript**: Минимальный JS для интерактивности на стороне клиента

## Структура проекта

```
remote-jobs/
├── cmd/                     # Точки входа в приложение
│   └── server/              # HTTP-сервер
│       └── main.go          # Точка входа для запуска сервера
├── internal/                # Внутренний код приложения
│   ├── config/              # Конфигурация приложения
│   ├── db/                  # Доступ к базе данных
│   │   ├── init_db.go       # Инициализация подключения к БД
│   │   └── repository/      # Репозитории для работы с сущностями в БД
│   ├── domain/              # Доменные модели и бизнес-логика
│   │   ├── entity/          # Сущности предметной области
│   │   └── service/         # Сервисы бизнес-логики
│   ├── handler/             # HTTP обработчики с серверным рендерингом
│   ├── logger/              # Настройка и инициализация логирования
│   ├── middleware/          # Промежуточные обработчики (middleware)
│   ├── router/              # Настройка маршрутизации на основе Chi
│   │   └── routes.go        # Определение маршрутов для Chi
│   ├── util/                # Вспомогательные функции и утилиты
│   └── view/                # Логика представления
│       ├── helper/          # Хелперы для шаблонов
│       └── model/           # Модели представления (ViewModel)
├── migrations/              # SQL-миграции для базы данных
├── static/                  # Статические файлы
│   ├── css/                 # CSS файлы, включая Bootstrap
│   ├── js/                  # JavaScript файлы
│   └── img/                 # Изображения и иконки
├── templates/               # HTML-шаблоны
│   ├── layout/              # Базовые шаблоны и макеты
│   │   ├── base.html        # Базовый макет сайта
│   │   └── components/      # Переиспользуемые компоненты
│   ├── pages/               # Шаблоны для отдельных страниц
│   │   ├── home.html        # Главная страница
│   │   ├── job_details.html # Страница вакансии
│   │   └── jobs_list.html   # Список вакансий
│   └── errors/              # Шаблоны страниц ошибок
├── documentation/           # Документация проекта
├── scripts/                 # Скрипты для сборки, деплоя и т.д.
├── .env                     # Файл с переменными окружения
├── go.mod                   # Описание зависимостей Go-модуля
└── README.md                # Общее описание проекта
```

## Компоненты архитектуры

### 1. Слоистая архитектура с серверным рендерингом

Приложение построено по принципу слоистой архитектуры с серверным рендерингом:

1. **Слой обработки HTTP-запросов** (Handlers) - обрабатывает запросы и рендерит HTML-шаблоны
2. **Слой бизнес-логики** (Services) - содержит основную логику работы приложения
3. **Слой доступа к данным** (Repositories) - отвечает за работу с базой данных
4. **Слой представления** (Templates) - HTML-шаблоны для отображения данных

### 2. Обработка HTTP-запросов с серверным рендерингом

```
Клиент -> Маршрутизатор -> Middleware -> Handler -> Service -> Repository -> БД
                                       |
                                       V
                                    Шаблоны -> HTML -> Клиент
```

- **Маршрутизатор**: Определяет, какой обработчик вызвать для каждого URL
- **Middleware**: Обрабатывает запрос перед его передачей обработчику (логирование, авторизация)
- **Handler**: Обрабатывает HTTP-запрос, вызывает необходимые сервисы и рендерит HTML-шаблоны
- **Service**: Реализует бизнес-логику, не зная о деталях HTTP или БД
- **Repository**: Взаимодействует с базой данных
- **Шаблоны**: Генерируют HTML-страницы на основе данных

### 3. Маршрутизация

Приложение использует роутер Chi, который обеспечивает идиоматичный подход к определению маршрутов и middleware в Go. Основные маршруты:

- **/** - Главная страница со списком вакансий и технологий
- **/{page}** - Пагинация списка вакансий (например, /2, /3)
- **/{technology}** - Список вакансий по конкретной технологии
- **/{technology}/{page}** - Пагинация списка вакансий по конкретной технологии (например, /2, /3)
- **/job/{id}-{slug}** - Страница конкретной вакансии. Slug формируется из названия вакансии латиницей

Пример настройки маршрутов с Chi:

```go
func NewRouter(handlers *handlers.Handlers) *chi.Mux {
    r := chi.NewRouter()
    
    // Middleware
    r.Use(middleware.Logger)
    r.Use(middleware.Recoverer)
    r.Use(middleware.Compress(5))
    
    // Статические файлы
    fileServer := http.FileServer(http.Dir("static"))
    r.Handle("/static/*", http.StripPrefix("/static/", fileServer))
    
    // Маршруты
    r.Get("/", handlers.HomeHandler.Index)
    r.Get("/{page}", handlers.HomeHandler.Index)
    r.Get("/{technology}", handlers.JobsHandler.ByTechnology)
    r.Get("/{technology}/{page}", handlers.JobsHandler.ByTechnology)
    r.Get("/job/{jobID}-{slug}", handlers.JobsHandler.Details)
    
    return r
}
```

### 4. HTML-шаблоны и Bootstrap

Для генерации HTML используется стандартный пакет Go `html/template`. Дизайн реализован с использованием Bootstrap для обеспечения адаптивности и современного внешнего вида.

Структура шаблонов:
- **Базовые шаблоны** (layout/base.html) - содержат общий HTML-каркас, подключение CSS и JS
- **Компоненты** (layout/components/) - переиспользуемые части интерфейса (шапка, подвал, пагинация)
- **Страницы** (pages/) - контент для конкретных страниц

Пример базового шаблона:
```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - Remote IT Jobs</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
</head>
<body>
    <header>
        {{template "header" .}}
    </header>
    
    <main class="container">
        {{template "content" .}}
    </main>
    
    <footer>
        {{template "footer" .}}
    </footer>
    
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/main.js"></script>
</body>
</html>
```

### 5. Модели представления (ViewModels)

Для передачи данных в шаблоны используются специальные модели представления, которые адаптируют доменные модели для отображения:

```go
// ViewModel для главной страницы
type HomePageViewModel struct {
    Title        string
    Jobs         []JobViewModel
    Technologies []TechnologyViewModel
    Pagination   PaginationViewModel
    CurrentPage  int
    TotalPages   int
}

// ViewModel для вакансии в списке
type JobViewModel struct {
    ID            int64
    Title         string
    MainTechnology string
    DatePosted    time.Time
    Description   string
    Slug          string
}
```

### 6. Подключение к базе данных

Подключение к базе данных инициализируется в модуле `internal/db/init_db.go` с использованием пула соединений `pgxpool`. Конфигурация загружается из переменных окружения или файла `.env`.

### 7. Логирование

Для логирования используется библиотека Zap с настройкой вывода в консоль и отправкой в BetterStack. Логгер уже проинициализирован и доступен во всех компонентах приложения.

## Подход к обработке ошибок

В проекте применяется комплексный подход к обработке ошибок:

1. **Уровни ошибок**:
   - **Системные ошибки**: Ошибки инфраструктуры (БД, сеть)
   - **Доменные ошибки**: Ошибки бизнес-логики
   - **Ошибки отображения**: Проблемы с рендерингом шаблонов

2. **Стратегия обработки**:
   - Ошибки должны обрабатываться на том уровне, где есть контекст для корректной обработки
   - Ошибки нижних уровней оборачиваются с добавлением контекста (`fmt.Errorf("действие: %w", err)`)
   - Критические ошибки логируются с уровнем Error и stack trace
   - Для пользователя отображаются дружественные страницы ошибок

3. **Структура журналирования ошибок**:
   ```go
   if err != nil {
       logger.Error("Не удалось получить список вакансий",
           zap.Error(err),
           zap.String("technology", technology),
           zap.Int("page", page))
       
       renderErrorPage(w, http.StatusInternalServerError)
       return
   }
   ```

4. **Страницы ошибок**:
   - Кастомные страницы для разных HTTP-статусов (404, 500 и т.д.)
   - Дружественные сообщения для пользователей
   - Возможность вернуться на главную или выполнить другие действия

## Процессы и потоки данных

### 1. Отображение списка вакансий (Главная страница)

```
GET / -> Chi Router -> HomeHandler.Index -> VacancyService.GetLatest -> VacancyRepository.GetLatest -> БД
                                          -> TechnologyService.GetAll -> TechnologyRepository.GetAll -> БД
                                          -> Рендеринг "home.html" -> HTML -> Клиент
```

### 2. Отображение вакансий по технологии

```
GET /{technology} -> Chi Router -> JobsHandler.ByTechnology -> VacancyService.GetByTechnology -> VacancyRepository.GetByTechnology -> БД
                                                             -> Рендеринг "jobs_list.html" -> HTML -> Клиент
```

### 3. Отображение конкретной вакансии

```
GET /job/{id}-{slug} -> Chi Router -> JobsHandler.Details -> VacancyService.GetByID -> VacancyRepository.GetByID -> БД
                                                           -> Рендеринг "job_details.html" -> HTML -> Клиент
```

## Производительность и оптимизация

1. **Оптимизация шаблонов**:
   - Предварительная компиляция шаблонов при запуске сервера
   - Кэширование скомпилированных шаблонов

2. **Оптимизация запросов к БД**:
   - Эффективные SQL-запросы
   - Ограничение выборки через LIMIT и OFFSET для пагинации
   - Использование индексов в базе данных

3. **Оптимизация статического контента**:
   - Минификация CSS и JavaScript
   - Настройка кэширования статических файлов в браузере
   - Использование gzip-сжатия

4. **Горизонтальное масштабирование**:
   - Приложение может быть развернуто в нескольких экземплярах за балансировщиком нагрузки
   - Состояние хранится в БД, а не в памяти приложения

## Безопасность

1. **Защита от инъекций SQL**:
   - Использование параметризованных запросов через pgx
   - Никаких прямых конкатенаций SQL-запросов

2. **Защита от XSS**:
   - Автоматическое экранирование всех данных в HTML-шаблонах
   - Использование Content Security Policy

3. **Безопасность шаблонов**:
   - Использование безопасных функций в шаблонах
   - Ограничение функциональности, доступной в шаблонах

## Заключение

Архитектура проекта "Remote Jobs" спроектирована как монолитное приложение с серверным рендерингом, что обеспечивает:

- **Простоту разработки**: Весь код на одном языке (Go)
- **Производительность**: Быстрый рендеринг HTML на сервере
- **SEO-оптимизация**: Полностью отрендеренные страницы для поисковых систем
- **Масштабируемость**: Возможность горизонтального масштабирования
- **Удобство сопровождения**: Четкая структура проекта и документация

Этот подход идеально подходит для проекта с удаленными вакансиями, где важны SEO, скорость загрузки страниц и простота разработки.
